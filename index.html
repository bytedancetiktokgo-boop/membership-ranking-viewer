<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TikTok GO メンバーシップ見込みステータス</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 980px; }
    .row { margin: 10px 0; }
    .muted { color: #666; font-size: 12px; line-height: 1.6; }
    .err { color: #b00020; white-space: pre-wrap; }
    .kv { display: grid; grid-template-columns: 360px 1fr; gap: 10px 14px; margin-top: 12px; }
    .k { font-weight: 600; color: #333; }
    a.btn {
      display: inline-block;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 10px;
      text-decoration: none;
      color: #111;
      background: #fff;
    }
    a#link { display:none; }
  </style>
</head>
<body>
  <h2>TikTok GO メンバーシップ見込みステータス</h2>

  <div class="card">
    <div class="row muted" id="status">Googleでログインしてください</div>
    <div id="gbtn" class="row"></div>

    <div id="error" class="row err" style="display:none;"></div>

    <!-- 正常表示 -->
    <div id="content" style="display:none;">
      <div class="row kv">
        <div class="k">Email</div><div id="email"></div>
        <div class="k">アカウント名</div><div id="account"></div>
        <div class="k">GMV（メンバーシップ計算対象の販売総額）</div><div id="gmv"></div>
        <div class="k">投稿数（メンバーシップ計算対象）</div><div id="postNumber"></div>
        <div class="k">販売レベル</div><div id="salesLevel"></div>
        <div class="k">販売総額順位（同一セールスレベル内）</div><div id="salesRank"></div>
        <div class="k">次回獲得見込みメンバーシップ</div><div id="nextMembership"></div>
        <div class="k">データ更新日（JST）</div><div id="updated"></div>
        <div class="k">備考</div><div id="note"></div>
        <div class="k">リンク</div>
        <div><a id="link" href="#" target="_blank" rel="noopener noreferrer">開く</a></div>
      </div>
    </div>

    <!-- データ無し表示 -->
    <div id="noData" style="display:none;">
      <div class="row err" style="font-weight:600;">アカウント情報が見つかりませんでした</div>
      <div class="row muted" id="noDataMsg"></div>
      <div class="row" style="margin-top:12px;">
        <a class="btn" id="formBtn" href="#" target="_blank" rel="noopener noreferrer">登録フォームを開く</a>
      </div>
    </div>
  </div>

<script>
  const CLIENT_ID = "1047878641876-tu8l1nj5e45hjo7iavjt0i55k3ut3nve.apps.googleusercontent.com";
  const API_URL = "https://membership-ranking-proxy.bytedance-tiktokgo.workers.dev"; // Worker URL
  const FORM_URL = "https://YOUR_INTERNAL_FORM_URL"; // ★ここだけ差し替え

  function showError(msg){
    const el = document.getElementById('error');
    el.style.display = 'block';
    el.textContent = msg;
  }
  function clearError(){
    const el = document.getElementById('error');
    el.style.display = 'none';
    el.textContent = '';
  }
  function showNoData(message){
    document.getElementById('content').style.display = 'none';
    document.getElementById('noData').style.display = 'block';
    document.getElementById('noDataMsg').textContent = message;
    document.getElementById('formBtn').href = FORM_URL;
  }
  function hideNoData(){
    document.getElementById('noData').style.display = 'none';
  }

  async function callApi(idToken){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ id_token: idToken })
    });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch (e) { return { ok:false, code:"NON_JSON", message:"non-json response", raw: txt }; }
  }

  // JSTで YYYY-MM-DD に整形（ISO文字列 / Date / 数値どれでも対応）
  function formatDateJST(v) {
    if (!v) return "";
    let d;
    try {
      d = (v instanceof Date) ? v : new Date(v);
      if (isNaN(d.getTime())) return String(v);
    } catch (_) {
      return String(v);
    }
    // IntlでAsia/Tokyoの年月日を取得
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Tokyo',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(d);
    const y = parts.find(p => p.type === 'year')?.value;
    const m = parts.find(p => p.type === 'month')?.value;
    const day = parts.find(p => p.type === 'day')?.value;
    if (y && m && day) return `${y}-${m}-${day}`;
    // フォールバック
    return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Tokyo' }).format(d);
  }

  window.onload = () => {
    document.getElementById('formBtn').href = FORM_URL;

    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: async (resp) => {
        clearError();
        hideNoData();
        document.getElementById('status').textContent = '確認中...';
        document.getElementById('content').style.display = 'none';

        try {
          const data = await callApi(resp.credential);
          document.getElementById('status').textContent = '';

          if (!data || !data.ok) {
            if (data && data.code === 'NO_RECORD') {
              const msg =
                "登録したGmailと一致するアカウントが見つかりませんでした。\n" +
                "登録から3営業日以上経っても反映されない場合は、お手数ですが登録フォームから再度お申し込みください。";
              showNoData(msg);
              return;
            }
            showError((data && (data.message || JSON.stringify(data, null, 2))) || 'Login failed');
            return;
          }

          // UIDは表示しない
          document.getElementById('content').style.display = 'block';
          document.getElementById('email').textContent = data.email || '';
          document.getElementById('account').textContent = data.record?.account_name ?? '';
          document.getElementById('gmv').textContent = data.record?.GMV ?? '';
          document.getElementById('postNumber').textContent = data.record?.post_number ?? '';
          document.getElementById('salesLevel').textContent = data.record?.sales_level ?? '';
          document.getElementById('salesRank').textContent = data.record?.sales_level_rank ?? '';
          document.getElementById('nextMembership').textContent = data.record?.next_membership ?? '';
          document.getElementById('updated').textContent = formatDateJST(data.record?.updated_at ?? '');
          document.getElementById('note').textContent = data.record?.note ?? '';

          const link = document.getElementById('link');
          const url = (data.record?.link_url ?? '').trim();
          if (url) {
            link.href = url;
            link.style.display = 'inline';
          } else {
            link.style.display = 'none';
          }

        } catch (e) {
          document.getElementById('status').textContent = '';
          showError(String(e));
        }
      }
    });

    google.accounts.id.renderButton(
      document.getElementById("gbtn"),
      { theme: "outline", size: "large", text: "signin_with" }
    );
  };
</script>
</body>
</html>
